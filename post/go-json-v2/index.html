<!doctype html><html lang=zh><head><title>Go JSON 的演变：从 v1 到 v2 &ndash; Code talks</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/palettes/base16-dark.css><link rel=stylesheet href=/css/risotto.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/favicon.ico><meta property="og:title" content="Go JSON 的演变：从 v1 到 v2 &ndash; Code talks"><meta property="og:url" content="/post/go-json-v2/"><meta property="og:locale" content="zh-CN"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4TVXFV2XZM%20"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4TVXFV2XZM ")}</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><li class=nomarker><h1 class=page__logo><a href=/ class=page__logo-inner>Code talks</a></h1></li><li class=main-nav__item><a class=nav-main-item href=/post title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class=nav-main-item href=https://github.com/douglarek title>GitHub</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Go JSON 的演变：从 v1 到 v2</h1><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6649330439620894" crossorigin=anonymous></script></header><div class=content__body><p>本文翻译自 <a href=https://antonz.org/go-json-v2/>Go JSON v2</a>，版权归原作者所有。</p><p>Go 1.25 中即将推出的 <code>json</code> 包的第二个版本是一次重大更新，包含许多破坏性变更。v2 包添加了新特性，修复了 API 问题和行为缺陷，并提升了性能。让我们来看看都有哪些变化！</p><p>使用 <code>Marshal</code> 和 <code>Unmarshal</code> 的基本用例保持不变。以下代码在 v1 和 v2 中都能正常工作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Age</span>  <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 序列化 Alice</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 反序列化 Alice</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>b</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>alice</span>, <span style=color:#a6e22e>err</span>)
</span></span></code></pre></div><p>但其余部分有很大不同。让我们来看看 v1 的主要变化。</p><h2 id=marshalwrite-和-unmarshalread>MarshalWrite 和 UnmarshalRead</h2><p>在 v1 中，你使用 <code>Encoder</code> 序列化到 <code>io.Writer</code>，使用 <code>Decoder</code> 从 <code>io.Reader</code> 反序列化：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 序列化 Alice</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>) <span style=color:#75715e>// io.Writer</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>enc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>Encode</span>(<span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 反序列化 Bob</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#e6db74>`{&#34;Name&#34;:&#34;Bob&#34;,&#34;Age&#34;:30}`</span>) <span style=color:#75715e>// io.Reader</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>bob</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>dec</span>.<span style=color:#a6e22e>Decode</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bob</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>bob</span>)
</span></span></code></pre></div><blockquote><p>从现在开始，我将省略错误处理以保持简洁。</p></blockquote><p>在 v2 中，你可以直接使用 <code>MarshalWrite</code> 和 <code>UnmarshalRead</code>，无需任何中间媒介：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 序列化 Alice</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalWrite</span>(<span style=color:#a6e22e>out</span>, <span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>String</span>())
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 反序列化 Bob</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#e6db74>`{&#34;Name&#34;:&#34;Bob&#34;,&#34;Age&#34;:30}`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>bob</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>UnmarshalRead</span>(<span style=color:#a6e22e>in</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>bob</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>bob</span>)
</span></span></code></pre></div><p>但它们并不完全可互换：</p><ul><li><code>MarshalWrite</code> 不添加换行符，而旧版 <code>Encoder.Encode</code> 会添加。</li><li><code>UnmarshalRead</code> 从 reader 读取所有内容直到遇到 <code>io.EOF</code>，而旧版 <code>Decoder.Decode</code> 只读取下一个 JSON 值。</li></ul><h2 id=marshalencode-和-unmarshaldecode>MarshalEncode 和 UnmarshalDecode</h2><p><code>Encoder</code> 和 <code>Decoder</code> 类型已经移至新的 <a href=https://pkg.go.dev/encoding/json/jsontext><code>jsontext</code></a> 包，且它们的接口已经发生了重大变化（以支持低级流式编码/解码操作）。</p><p>你可以将它们与 <code>json</code> 函数一起使用，以读写 JSON 流，类似于之前 <code>Encode</code> 和 <code>Decode</code> 的工作方式：</p><ul><li>v1 <code>Encoder.Encode</code> → v2 <code>json.MarshalEncode</code> + <code>jsontext.Encoder</code>。</li><li>v1 <code>Decoder.Decode</code> → v2 <code>json.UnmarshalDecode</code> + <code>jsontext.Decoder</code>。</li></ul><p>流式编码器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>people</span> <span style=color:#f92672>:=</span> []<span style=color:#a6e22e>Person</span>{
</span></span><span style=display:flex><span>    {<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>},
</span></span><span style=display:flex><span>    {<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Bob&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>30</span>},
</span></span><span style=display:flex><span>    {<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Cindy&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>15</span>},
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>out</span> <span style=color:#f92672>:=</span> new(<span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>enc</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>NewEncoder</span>(<span style=color:#a6e22e>out</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>p</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>people</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalEncode</span>(<span style=color:#a6e22e>enc</span>, <span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Print</span>(<span style=color:#a6e22e>out</span>.<span style=color:#a6e22e>String</span>())
</span></span></code></pre></div><p>流式解码器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>in</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>NewReader</span>(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;Name&#34;:&#34;Alice&#34;,&#34;Age&#34;:25}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;Name&#34;:&#34;Bob&#34;,&#34;Age&#34;:30}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{&#34;Name&#34;:&#34;Cindy&#34;,&#34;Age&#34;:15}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>`</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>dec</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>NewDecoder</span>(<span style=color:#a6e22e>in</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>for</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>p</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 每次调用解码一个 Person 对象</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>UnmarshalDecode</span>(<span style=color:#a6e22e>dec</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>==</span> <span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>EOF</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>break</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>p</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>与 <code>UnmarshalRead</code> 不同，<code>UnmarshalDecode</code> 以完全流式方式工作，每次调用解码一个值，而不是读取所有内容直到 <code>io.EOF</code>。</p><h2 id=选项>选项</h2><p>选项用于配置序列化和反序列化函数的特定功能：</p><ul><li><code>FormatNilMapAsNull</code> 和 <code>FormatNilSliceAsNull</code> 定义如何编码 nil 映射和切片。</li><li><code>MatchCaseInsensitiveNames</code> 允许匹配 <code>Name</code> ↔ <code>name</code> 等。</li><li><code>Multiline</code> 将 JSON 对象展开为多行。</li><li><code>OmitZeroStructFields</code> 从输出中省略零值字段。</li><li><code>SpaceAfterColon</code> 和 <code>SpaceAfterComma</code> 在每个 <code>:</code> 或 <code>,</code> 后添加空格。</li><li><code>StringifyNumbers</code> 将数字类型表示为字符串。</li><li><code>WithIndent</code> 和 <code>WithIndentPrefix</code> 缩进嵌套属性（注意 <code>MarshalIndent</code> 函数已被移除）。</li></ul><p>每个序列化或反序列化函数可以接受任意数量的选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alice</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>OmitZeroStructFields</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>StringifyNumbers</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>WithIndent</span>(<span style=color:#e6db74>&#34; &#34;</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span></code></pre></div><p>你也可以使用 <code>JoinOptions</code> 组合选项：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{<span style=color:#a6e22e>Name</span>: <span style=color:#e6db74>&#34;Alice&#34;</span>, <span style=color:#a6e22e>Age</span>: <span style=color:#ae81ff>25</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>opts</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>JoinOptions</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>SpaceAfterColon</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>SpaceAfterComma</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>alice</span>, <span style=color:#a6e22e>opts</span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span></code></pre></div><p>查看文档中的完整选项列表：有些在 <a href=https://pkg.go.dev/encoding/json/v2#Options><code>json</code></a> 包中，有些在 <a href=https://pkg.go.dev/encoding/json/jsontext#Options><code>jsontext</code></a> 包中。</p><h2 id=标签>标签</h2><p>v2 支持在 v1 中定义的字段标签：</p><ul><li><code>omitzero</code> 和 <code>omitempty</code> 用于省略空值。</li><li><code>string</code> 将数字类型表示为字符串。</li><li><code>-</code> 用于忽略字段。</li></ul><p>并添加了一些新的标签：</p><ul><li><code>case:ignore</code> 或 <code>case:strict</code> 指定如何处理大小写差异。</li><li><code>format:template</code> 根据模板格式化字段值。</li><li><code>inline</code> 通过将嵌套对象的字段提升到父级来扁平化输出。</li><li><code>unknown</code> 为未知字段提供"全部捕获"。</li></ul><p>下面是演示 <code>inline</code> 和 <code>format</code> 的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>      <span style=color:#66d9ef>string</span>    <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 格式化日期为 yyyy-mm-dd</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>BirthDate</span> <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Time</span> <span style=color:#e6db74>`json:&#34;birth_date,format:DateOnly&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将 Address 字段内联到 Person 对象中</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Address</span>   <span style=color:#e6db74>`json:&#34;,inline&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Address</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Street</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;street&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>City</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;city&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:      <span style=color:#e6db74>&#34;Alice&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>BirthDate</span>: <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>Date</span>(<span style=color:#ae81ff>2001</span>, <span style=color:#ae81ff>7</span>, <span style=color:#ae81ff>15</span>, <span style=color:#ae81ff>12</span>, <span style=color:#ae81ff>35</span>, <span style=color:#ae81ff>43</span>, <span style=color:#ae81ff>0</span>, <span style=color:#a6e22e>time</span>.<span style=color:#a6e22e>UTC</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Address</span>: <span style=color:#a6e22e>Address</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>Street</span>: <span style=color:#e6db74>&#34;123 Main St&#34;</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>City</span>:   <span style=color:#e6db74>&#34;Wonderland&#34;</span>,
</span></span><span style=display:flex><span>        },
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>alice</span>, <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>WithIndent</span>(<span style=color:#e6db74>&#34; &#34;</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>还有 <code>unknown</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;name&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 将所有未知的 Person 字段收集到 Data 字段中</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Data</span> <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>any</span> <span style=color:#e6db74>`json:&#34;,unknown&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> <span style=color:#e6db74>`{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;name&#34;: &#34;Alice&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;hobby&#34;: &#34;adventure&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    &#34;friends&#34;: [
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;name&#34;: &#34;Bob&#34;},
</span></span></span><span style=display:flex><span><span style=color:#e6db74>        {&#34;name&#34;: &#34;Cindy&#34;}
</span></span></span><span style=display:flex><span><span style=color:#e6db74>    ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>alice</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>([]byte(<span style=color:#a6e22e>src</span>), <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><h2 id=自定义序列化>自定义序列化</h2><p>使用 <code>Marshaler</code> 和 <code>Unmarshaler</code> 接口的基本自定义序列化用例保持不变。此代码在 v1 和 v2 中都能正常工作：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 一个自定义布尔类型，表示为 &#34;✓&#34; 表示 true，&#34;✗&#34; 表示 false</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#a6e22e>Success</span>) <span style=color:#a6e22e>MarshalJSON</span>() ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> []byte(<span style=color:#e6db74>`&#34;✓&#34;`</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> []byte(<span style=color:#e6db74>`&#34;✗&#34;`</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Success</span>) <span style=color:#a6e22e>UnmarshalJSON</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 为简洁起见省略数据验证</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>s</span> = string(<span style=color:#a6e22e>data</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>`&#34;✓&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 序列化</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Success</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反序列化</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`&#34;✓&#34;`</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>src</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>然而，Go 标准库文档推荐使用新的 <code>MarshalerTo</code> 和 <code>UnmarshalerFrom</code> 接口（它们以纯流式方式工作，这可能快得多）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 一个自定义布尔类型，表示为 &#34;✓&#34; 表示 true，&#34;✗&#34; 表示 false</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Success</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#a6e22e>Success</span>) <span style=color:#a6e22e>MarshalJSONTo</span>(<span style=color:#a6e22e>enc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Encoder</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✓&#34;</span>))
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✗&#34;</span>))
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>s</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>Success</span>) <span style=color:#a6e22e>UnmarshalJSONFrom</span>(<span style=color:#a6e22e>dec</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Decoder</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 为简洁起见省略数据验证</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>tok</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>dec</span>.<span style=color:#a6e22e>ReadToken</span>()
</span></span><span style=display:flex><span>    <span style=color:#f92672>*</span><span style=color:#a6e22e>s</span> = <span style=color:#a6e22e>tok</span>.<span style=color:#a6e22e>String</span>() <span style=color:#f92672>==</span> <span style=color:#e6db74>`&#34;✓&#34;`</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>err</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 序列化</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Success</span>(<span style=color:#66d9ef>true</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#75715e>// 反序列化</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`&#34;✓&#34;`</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>err</span> = <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>src</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>val</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>更好的是，你不再局限于特定类型的单一序列化方式。现在，你可以在需要时使用自定义序列化器和反序列化器，使用通用的 <code>MarshalFunc</code> 和 <code>UnmarshalFunc</code> 函数。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MarshalFunc</span>[<span style=color:#a6e22e>T</span> <span style=color:#66d9ef>any</span>](<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>T</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>)) <span style=color:#f92672>*</span><span style=color:#a6e22e>Marshalers</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>UnmarshalFunc</span>[<span style=color:#a6e22e>T</span> <span style=color:#66d9ef>any</span>](<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>([]<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>error</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Unmarshalers</span>
</span></span></code></pre></div><p>例如，你可以将 <code>bool</code> 值序列化为 <code>✓</code> 或 <code>✗</code> 而无需创建自定义类型：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 用于布尔值的自定义序列化器</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>boolMarshaler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalFunc</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>val</span> <span style=color:#66d9ef>bool</span>) ([]<span style=color:#66d9ef>byte</span>, <span style=color:#66d9ef>error</span>) {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> []byte(<span style=color:#e6db74>`&#34;✓&#34;`</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> []byte(<span style=color:#e6db74>`&#34;✗&#34;`</span>), <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通过 WithMarshalers 选项传递自定义序列化器给 Marshal</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>val</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>WithMarshalers</span>(<span style=color:#a6e22e>boolMarshaler</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>err</span>)
</span></span></code></pre></div><p>并将 <code>✓</code> 或 <code>✗</code> 反序列化为 <code>bool</code>：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 用于布尔值的自定义反序列化器</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>boolUnmarshaler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>UnmarshalFunc</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>data</span> []<span style=color:#66d9ef>byte</span>, <span style=color:#a6e22e>val</span> <span style=color:#f92672>*</span><span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#f92672>*</span><span style=color:#a6e22e>val</span> = string(<span style=color:#a6e22e>data</span>) <span style=color:#f92672>==</span> <span style=color:#e6db74>`&#34;✓&#34;`</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 通过 WithUnmarshalers 选项传递自定义反序列化器给 Unmarshal</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`&#34;✓&#34;`</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>bool</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>src</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>WithUnmarshalers</span>(<span style=color:#a6e22e>boolUnmarshaler</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>val</span>, <span style=color:#a6e22e>err</span>)
</span></span></code></pre></div><p>也有 <code>MarshalToFunc</code> 和 <code>UnmarshalFromFunc</code> 函数用于创建自定义序列化器。它们类似于 <code>MarshalFunc</code> 和 <code>UnmarshalFunc</code>，但使用 <code>jsontext.Encoder</code> 和 <code>jsontext.Decoder</code> 而不是字节切片。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>MarshalToFunc</span>[<span style=color:#a6e22e>T</span> <span style=color:#66d9ef>any</span>](<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Encoder</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>error</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Marshalers</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>UnmarshalFromFunc</span>[<span style=color:#a6e22e>T</span> <span style=color:#66d9ef>any</span>](<span style=color:#a6e22e>fn</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Decoder</span>, <span style=color:#a6e22e>T</span>) <span style=color:#66d9ef>error</span>) <span style=color:#f92672>*</span><span style=color:#a6e22e>Unmarshalers</span>
</span></span></code></pre></div><p>你可以使用 <code>JoinMarshalers</code> 组合序列化器（使用 <code>JoinUnmarshalers</code> 组合反序列化器）。例如，这里展示了如何将布尔值（<code>true</code>/<code>false</code>）和"类布尔"字符串（<code>on</code>/<code>off</code>）序列化为 <code>✓</code> 或 <code>✗</code>，同时保留所有其他值的默认序列化方式。</p><p>首先定义一个布尔值的自定义序列化器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 将布尔值序列化为 ✓ 或 ✗</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>boolMarshaler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalToFunc</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>enc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Encoder</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>bool</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✓&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✗&#34;</span>))
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>然后定义一个类布尔字符串的自定义序列化器：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 将类布尔字符串序列化为 ✓ 或 ✗</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>strMarshaler</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MarshalToFunc</span>(
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>enc</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Encoder</span>, <span style=color:#a6e22e>val</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;on&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;true&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✓&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>if</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;off&#34;</span> <span style=color:#f92672>||</span> <span style=color:#a6e22e>val</span> <span style=color:#f92672>==</span> <span style=color:#e6db74>&#34;false&#34;</span> {
</span></span><span style=display:flex><span>            <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>enc</span>.<span style=color:#a6e22e>WriteToken</span>(<span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>String</span>(<span style=color:#e6db74>&#34;✗&#34;</span>))
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// SkipFunc 是一种特殊类型的错误，告诉 Go 跳过当前序列化器</span>
</span></span><span style=display:flex><span>        <span style=color:#75715e>// 并继续下一个。在我们的例子中，下一个将是字符串的默认序列化器。</span>
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>SkipFunc</span>
</span></span><span style=display:flex><span>    },
</span></span><span style=display:flex><span>)
</span></span></code></pre></div><p>最后，使用 <code>JoinMarshalers</code> 组合序列化器，并通过 <code>WithMarshalers</code> 选项将它们传递给序列化函数：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 使用 JoinMarshalers 组合自定义序列化器</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>marshalers</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>JoinMarshalers</span>(<span style=color:#a6e22e>boolMarshaler</span>, <span style=color:#a6e22e>strMarshaler</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 序列化一些值</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>vals</span> <span style=color:#f92672>:=</span> []<span style=color:#66d9ef>any</span>{<span style=color:#66d9ef>true</span>, <span style=color:#e6db74>&#34;off&#34;</span>, <span style=color:#e6db74>&#34;hello&#34;</span>}
</span></span><span style=display:flex><span><span style=color:#a6e22e>data</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>vals</span>, <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>WithMarshalers</span>(<span style=color:#a6e22e>marshalers</span>))
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>data</span>), <span style=color:#a6e22e>err</span>)
</span></span></code></pre></div><p>这不是很酷吗？</p><h2 id=默认行为>默认行为</h2><p>v2 不仅改变了包接口，还改变了默认的序列化/反序列化行为。</p><p>一些值得注意的<strong>序列化差异</strong>包括：</p><ul><li>v1 将 nil 切片序列化为 <code>null</code>，v2 序列化为 <code>[]</code>。你可以使用 <code>FormatNilSliceAsNull</code> 选项更改它。</li><li>v1 将 nil 映射序列化为 <code>null</code>，v2 序列化为 <code>{}</code>。你可以使用 <code>FormatNilMapAsNull</code> 选项更改它。</li><li>v1 将字节数组序列化为数字数组，v2 序列化为 base64 编码的字符串。你可以使用 <code>format:array</code> 和 <code>format:base64</code> 标签更改它。</li><li>v1 允许字符串内的无效 UTF-8 字符，v2 不允许。你可以使用 <code>AllowInvalidUTF8</code> 选项更改它。</li></ul><p>以下是 v2 默认行为的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Hobbies</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Skills</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Secret</span>  [<span style=color:#ae81ff>5</span>]<span style=color:#66d9ef>byte</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:   <span style=color:#e6db74>&#34;Alice&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Secret</span>: [<span style=color:#ae81ff>5</span>]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(<span style=color:#a6e22e>alice</span>, <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Multiline</span>(<span style=color:#66d9ef>true</span>))
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以下是如何强制 v1 行为：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Name</span>    <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Hobbies</span> []<span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Skills</span>  <span style=color:#66d9ef>map</span>[<span style=color:#66d9ef>string</span>]<span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Secret</span>  [<span style=color:#ae81ff>5</span>]<span style=color:#66d9ef>byte</span> <span style=color:#e6db74>`json:&#34;,format:array&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>alice</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>Person</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Name</span>:   <span style=color:#e6db74>&#34;Alice&#34;</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>Secret</span>: [<span style=color:#ae81ff>5</span>]<span style=color:#66d9ef>byte</span>{<span style=color:#ae81ff>1</span>, <span style=color:#ae81ff>2</span>, <span style=color:#ae81ff>3</span>, <span style=color:#ae81ff>4</span>, <span style=color:#ae81ff>5</span>},
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>b</span>, <span style=color:#a6e22e>_</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Marshal</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>alice</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>FormatNilMapAsNull</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>FormatNilSliceAsNull</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>jsontext</span>.<span style=color:#a6e22e>Multiline</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(string(<span style=color:#a6e22e>b</span>))
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>一些值得注意的<strong>反序列化差异</strong>包括：</p><ul><li>v1 使用不区分大小写的字段名匹配，v2 使用精确的区分大小写匹配。你可以使用 <code>MatchCaseInsensitiveNames</code> 选项或 <code>case</code> 标签更改它。</li><li>v1 允许对象中的重复字段，v2 不允许。你可以使用 <code>AllowDuplicateNames</code> 选项更改它。</li></ul><p>以下是 v2 默认行为（区分大小写）的示例：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FirstName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastName</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`{&#34;firstname&#34;:&#34;Alice&#34;,&#34;lastname&#34;:&#34;Zakas&#34;}`</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>alice</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>src</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%+v\n&#34;</span>, <span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>以下是如何强制 v1 行为（不区分大小写）：</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Person</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>FirstName</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>LastName</span>  <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>src</span> <span style=color:#f92672>:=</span> []byte(<span style=color:#e6db74>`{&#34;firstname&#34;:&#34;Alice&#34;,&#34;lastname&#34;:&#34;Zakas&#34;}`</span>)
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>var</span> <span style=color:#a6e22e>alice</span> <span style=color:#a6e22e>Person</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>src</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>alice</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>MatchCaseInsensitiveNames</span>(<span style=color:#66d9ef>true</span>),
</span></span><span style=display:flex><span>    )
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%+v\n&#34;</span>, <span style=color:#a6e22e>alice</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>在<a href=https://pkg.go.dev/encoding/json@master#hdr-Migrating_to_v2>文档</a>中可以查看行为变化的完整列表。</p><h2 id=性能>性能</h2><p>在序列化时，v2 与 v1 的表现大致相同。它对某些数据集更快，但对其他数据集更慢。然而，反序列化要<strong>好得多</strong>：v2 比 v1 快 2.7 倍到 10.2 倍。</p><p>此外，通过从常规的 <code>MarshalJSON</code> 和 <code>UnmarshalJSON</code> 切换到它们的流式替代方案 — <code>MarshalJSONTo</code> 和 <code>UnmarshalJSONFrom</code>，可以获得显著的性能提升。根据 Go 团队的说法，它可以将某些 O(n²) 运行时场景转换为 O(n)。例如，在 k8s OpenAPI 规范中从 <code>UnmarshalJSON</code> 切换到 <code>UnmarshalJSONFrom</code> 使其速度<a href=https://github.com/kubernetes/kube-openapi/issues/315#issuecomment-1240030015>提高了约 40 倍</a>。</p><p>有关基准测试详情，请参阅 <a href=https://github.com/go-json-experiment/jsonbench#readme>jsonbench</a> 仓库。</p><h2 id=最终思考>最终思考</h2><p>呼！这里有太多要吸收的内容。v2 包比 v1 有更多功能且更灵活，但它也更复杂，特别是考虑到分成 <code>json/v2</code> 和 <code>jsontext</code> 子包。</p><p>需要记住的几点：</p><ul><li>截至 Go 1.25，<code>json/v2</code> 包仍处于实验阶段，可以通过在构建时设置 <code>GOEXPERIMENT=jsonv2</code> 来启用。包 API 可能在未来的版本中发生变化。</li><li>开启 <code>GOEXPERIMENT=jsonv2</code> 会让 v1 <code>json</code> 包使用新的 JSON 实现，这更快并支持一些选项，以便与旧的序列化和反序列化行为更好地兼容。</li></ul><p>最后，以下是一些了解 v2 设计和实现的链接：</p><p><a href=https://go.dev/issue/63397>提案第一部分</a> • <a href=https://go.dev/issue/71497>提案第二部分</a> • <a href=https://github.com/golang/go/tree/master/src/encoding/json/v2>json/v2</a> • <a href=https://github.com/golang/go/tree/master/src/encoding/json/jsontext>jsontext</a></p></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//douglarek.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=content__footer></footer></section><section class=page__aside><div class=aside__content><p>2025-07-17</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#marshalwrite-和-unmarshalread>MarshalWrite 和 UnmarshalRead</a></li><li><a href=#marshalencode-和-unmarshaldecode>MarshalEncode 和 UnmarshalDecode</a></li><li><a href=#选项>选项</a></li><li><a href=#标签>标签</a></li><li><a href=#自定义序列化>自定义序列化</a></li><li><a href=#默认行为>默认行为</a></li><li><a href=#性能>性能</a></li><li><a href=#最终思考>最终思考</a></li></ul></nav></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Copyright © 2025 Leo Douglas</p></footer></div></body></html>