<!doctype html><html lang=zh><head><title>Go JSON 技巧 &ndash; Code talks</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/palettes/base16-dark.css><link rel=stylesheet href=/css/risotto.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/favicon.ico><meta property="og:title" content="Go JSON 技巧 &ndash; Code talks"><meta property="og:url" content="/post/json-tips-in-go/"><meta property="og:locale" content="zh-CN"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4TVXFV2XZM%20"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4TVXFV2XZM ")}</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><li class=nomarker><h1 class=page__logo><a href=/ class=page__logo-inner>Code talks</a></h1></li><li class=main-nav__item><a class=nav-main-item href=/post title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class=nav-main-item href=https://github.com/douglarek title>GitHub</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Go JSON 技巧</h1><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6649330439620894" crossorigin=anonymous></script></header><div class=content__body><p>相对于很多的语言来说, Go 的 JSON 解析可谓简单至极.</p><h2 id=问题>问题</h2><p>通常情况下, 我们在 Go 中经常这样进行 JSON 的解码:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// jsonText comes from http://json.org/example.html</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>jsonText</span> = []byte(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   &#34;glossary&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;title&#34;:&#34;example glossary&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      &#34;GlossDiv&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;title&#34;:&#34;S&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         &#34;GlossList&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            &#34;GlossEntry&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;ID&#34;:&#34;SGML&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;SortAs&#34;:&#34;SGML&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;GlossTerm&#34;:&#34;Standard Generalized Markup Language&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;Acronym&#34;:&#34;SGML&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;Abbrev&#34;:&#34;ISO 8879:1986&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;GlossDef&#34;:{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                  &#34;para&#34;:&#34;A meta-markup language, used to create markup languages such as DocBook.&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                  &#34;GlossSeeAlso&#34;:[
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                     &#34;GML&#34;,
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                     &#34;XML&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>                  ]
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               },
</span></span></span><span style=display:flex><span><span style=color:#e6db74>               &#34;GlossSee&#34;:&#34;markup&#34;
</span></span></span><span style=display:flex><span><span style=color:#e6db74>            }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>         }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>      }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   }
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}`</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>glossary</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Glossary</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Title</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;title&#34;`</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>GlossDiv</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Title</span>     <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;title&#34;`</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>GlossList</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>				<span style=color:#a6e22e>GlossEntry</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>ID</span>        <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;ID&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>SortAs</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;SortAs&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>GlossTerm</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;GlossTerm&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Acronym</span>   <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;Acronym&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>Abbrev</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;Abbrev&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>GlossDef</span>  <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>Para</span>         <span style=color:#66d9ef>string</span>   <span style=color:#e6db74>`json:&#34;para&#34;`</span>
</span></span><span style=display:flex><span>						<span style=color:#a6e22e>GlossSeeAlso</span> []<span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;GlossSeeAlso&#34;`</span>
</span></span><span style=display:flex><span>					} <span style=color:#e6db74>`json:&#34;GlossDef&#34;`</span>
</span></span><span style=display:flex><span>					<span style=color:#a6e22e>GlossSee</span> <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;GlossSee&#34;`</span>
</span></span><span style=display:flex><span>				} <span style=color:#e6db74>`json:&#34;GlossEntry&#34;`</span>
</span></span><span style=display:flex><span>			} <span style=color:#e6db74>`json:&#34;GlossList&#34;`</span>
</span></span><span style=display:flex><span>		} <span style=color:#e6db74>`json:&#34;GlossDiv&#34;`</span>
</span></span><span style=display:flex><span>	} <span style=color:#e6db74>`json:&#34;glossary&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>g</span> <span style=color:#a6e22e>glossary</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>jsonText</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>这样的解码对于我们日常使用好像也没什么问题, 起码能用 ? 对于一段 JSON, 我们解码的时候未必需要立即解码所有的部分, 什么意思呢 ?</p><p>拿上面的例子代码来说, 我们解码 jsonText , 可能仅需要马上使用 Title 和 GlossDiv.Title . 那么对于这种情况我们怎么做合适呢 ?</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> <span style=color:#e6db74>&#34;encoding/json&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// jsonText comes from http://json.org/example.html</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>jsonText</span> = []byte(<span style=color:#e6db74>`
</span></span></span><span style=display:flex><span><span style=color:#e6db74>{
</span></span></span><span style=display:flex><span><span style=color:#e6db74>   ... // 此处省略, 同上
</span></span></span><span style=display:flex><span><span style=color:#e6db74>}`</span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>glossarySectional</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Glossary</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>Title</span>    <span style=color:#66d9ef>string</span> <span style=color:#e6db74>`json:&#34;title&#34;`</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>GlossDiv</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>Title</span>     <span style=color:#66d9ef>string</span>          <span style=color:#e6db74>`json:&#34;title&#34;`</span>
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>GlossList</span> <span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>RawMessage</span> <span style=color:#e6db74>`json:&#34;GlossList&#34;`</span> <span style=color:#75715e>// diff: delay JSON decoding</span>
</span></span><span style=display:flex><span>		} <span style=color:#e6db74>`json:&#34;GlossDiv&#34;`</span>
</span></span><span style=display:flex><span>	} <span style=color:#e6db74>`json:&#34;glossary&#34;`</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>g</span> <span style=color:#a6e22e>glossarySectional</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>jsonText</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>没错, 魔法就在 GlossList json.RawMessage . 我们看相关<a href=https://golang.org/pkg/encoding/json/#RawMessage>文档</a>怎么说:</p><blockquote><p>RawMessage is a raw encoded JSON value. It implements Marshaler and Unmarshaler and can be used to delay JSON decoding or precompute a JSON encoding.</p></blockquote><p>一目了然, RawMessage 起到了延迟解码一个 JSON 值的作用. 那么你可能会说, 这有啥用呢 ?</p><p>这对于普通的解码可能问题不大, 但是对于一些像消息传递(Kafka 这种), 细微的延迟可能会造成很大的影响. 我们可以通过简单的 benchmark 测试一下这细微的差别:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// 其他代码略 ... 完整代码参见: http://bit.ly/2skxY9L .</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>benchmarkJSONUnmarshal</span>(<span style=color:#a6e22e>f</span> <span style=color:#66d9ef>func</span>(), <span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#ae81ff>0</span>; <span style=color:#a6e22e>n</span> &lt; <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>N</span>; <span style=color:#a6e22e>n</span><span style=color:#f92672>++</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>()
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkJSONUnmarshal_0</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>benchmarkJSONUnmarshal</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>g</span> <span style=color:#a6e22e>glossary</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>jsonText</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>	}, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>BenchmarkJSONUnmarshal_1</span>(<span style=color:#a6e22e>b</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>testing</span>.<span style=color:#a6e22e>B</span>) {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>benchmarkJSONUnmarshal</span>(<span style=color:#66d9ef>func</span>() {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>g</span> <span style=color:#a6e22e>glossarySectional</span>
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>json</span>.<span style=color:#a6e22e>Unmarshal</span>(<span style=color:#a6e22e>jsonText</span>, <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>g</span>)
</span></span><span style=display:flex><span>	}, <span style=color:#a6e22e>b</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们通过运行 go test -run=NONE -bench=. ./&mldr; 可以得出(不同环境有略微差别):</p><pre tabindex=0><code>BenchmarkJSONUnmarshal_0-8   	  200000	     10565 ns/op
BenchmarkJSONUnmarshal_1-8   	  200000	      7699 ns/op
</code></pre><p>差别幅度:</p><pre tabindex=0><code>benchmark                    old ns/op     new ns/op     delta
BenchmarkJSONUnmarshal-8     10298         7591          -26.29%
</code></pre><p>可以看得出这个差别还是很大的, 特别是当 JSON 本身体量很大的时候.</p><h2 id=结论>结论</h2><p>对于一些关乎性能的 JSON 解析的处理, 我们可以通过 json.RawMessage 进行性能的提升.</p></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//douglarek.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=content__footer></footer></section><section class=page__aside><div class=aside__content><p>2018-02-10</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#问题>问题</a></li><li><a href=#结论>结论</a></li></ul></nav></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Copyright © 2025 Leo Douglas</p></footer></div></body></html>