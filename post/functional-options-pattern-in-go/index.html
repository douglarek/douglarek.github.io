<!doctype html><html lang=zh><head><title>Go 函数选项模式 &ndash; Code talks</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/palettes/base16-dark.css><link rel=stylesheet href=/css/risotto.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/favicon.ico><meta property="og:title" content="Go 函数选项模式 &ndash; Code talks"><meta property="og:url" content="/post/functional-options-pattern-in-go/"><meta property="og:locale" content="zh-CN"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4TVXFV2XZM%20"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4TVXFV2XZM ")}</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><li class=nomarker><h1 class=page__logo><a href=/ class=page__logo-inner>Code talks</a></h1></li><li class=main-nav__item><a class=nav-main-item href=/post title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class=nav-main-item href=https://github.com/douglarek title>GitHub</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Go 函数选项模式</h1><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6649330439620894" crossorigin=anonymous></script></header><div class=content__body><p>本文翻译自 <a href=https://halls-of-valhalla.org/beta/articles/functional-options-pattern-in-go,54/>Functional Options Pattern in Go</a>，版权归原作者所有。</p><p>Golang 开发者遇到的许多问题之一是尝试将一个函数的参数设置为可选. 这是一个非常常见的用例, 有些对象应该使用一些基本的默认设置来开箱即用, 并且你偶尔可能需要提供一些更详细的配置.</p><p>在很多语言中这很容易; 在 C 族语言中, 可以使用不同数量的参数提供相同函数的多个版本; 在像 PHP 这样的语言中, 可以给参数一个默认值，并在调用方法时忽略它们. 但是在 Golang 中, 这两种方式你哪个也用不了. 那么你如何创建一个函数, 用户可以指定一些额外的配置?</p><p>有很多可能的方法可以做到这一点, 但是大多数都不能满足要求, 或者需要在服务端的代码中进行额外的检查和验证, 或者通过传递额外的客户端不关心的参数来为客户端做额外的工作.</p><p>我将介绍一些不同的方案, 并说明为什么每个都不是最理想的, 然后我们将建立我们自己的方式来作为最终干净的解决方案: 函数式选项模式 (Functional Options Pattern).</p><p>我们来看一个例子. 比方说, 我们有一些名为 StuffClient 的服务, 它有一些东西, 并有两个配置选项(timeout 和 retries):</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>结构体 stuffClient 是私有的, 所以我们应该为它提供一些构造器:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>timeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>retries</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>嗯, 但是现在我们每次调用 NewStuffClient 时都要提供 timeout 和 retries. 而大多数时候我们只想使用默认值. 我们不能用不同的参数数量来定义多个版本的 NewStuffClient, 否则我们会得到一个类似 &ldquo;NewStuffClient redeclared in this blockt&rdquo; 的编译错误.</p><p>一个方案是创建另一个不同名称的构造器:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>DEFAULT_TIMEOUT</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>DEFAULT_RETRIES</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClientWithOptions</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>timeout</span>, <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>timeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>retries</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>但是, 这有点蹩脚. 我们可以做得比这更好. 如果我们传入了一个配置对象呢:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>options</span> <span style=color:#a6e22e>StuffClientOptions</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>但是, 这也不是很好. 现在我们总是需要创建 StuffClientOptions, 并且即使我们不想指定任何选项也要传递它. 而且我们也没有自动填充默认值, 除非我们在代码中添加了一堆检查, 或者我们可以传入一个 DefaultStuffClientOptions 变量 (也不好, 因为它可以在一个地方修改导致其他地方有问题).</p><p>那么解决方案是什么? 解决这个难题最好的方法是使用函数式选项模式, 利用 Go 对闭包的方便支持. 让我们继续我们上面定义的 StuffClientOptions, 但是我们会添加一些东西:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Retries</span> = <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Timeout</span> = <span style=color:#a6e22e>t</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>泥土般芬芳, 对吧? 究竟发生了什么? 基本上我们有我们的结构定义我们的 StuffClient 的可用选项. 另外现在我们定义了一个名为 StuffClientOption 的东东(这次是单数), 它只是一个接受我们的选项 struct 作为参数的函数. 我们已经定义了另外一些函数 WithRetries 和 WithTimeout, 它们返回一个闭包. 现在魔法降临:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClientOptions</span> = <span style=color:#a6e22e>StuffClientOptions</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Retries</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClientOptions</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们已经定义了一个额外的未导出(unexposed)变量, 包含我们的默认选项, 我们现在调整了我们的构造函数, 而不是接受一个可变参数. 然后, 我们遍历 StuffClientOption (单数) 列表, 并对每一项应用返回的闭包到我们的选项变量.</p><p>现在我们要做的就是这样:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>x</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>Connection</span>{})
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 2 3}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>NewStuffClient</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Connection</span>{},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithRetries</span>(<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 2 1}</span>
</span></span><span style=display:flex><span><span style=color:#a6e22e>x</span> = <span style=color:#a6e22e>NewStuffClient</span>(
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Connection</span>{},
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithRetries</span>(<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#ae81ff>1</span>),
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span><span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>x</span>) <span style=color:#75715e>// prints &amp;{{} 1 1}</span>
</span></span></code></pre></div><p>这看起来相当不错而且可用. 而关于它的好的部分是, 我们可以随时添加新的选项, 只需要对代码进行非常少量的更改. 把这些都组合起来就是这样:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClientOptions</span> = <span style=color:#a6e22e>StuffClientOptions</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Retries</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOptions</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Retries</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//number of times to retry the request before giving up</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>Timeout</span> <span style=color:#66d9ef>int</span> <span style=color:#75715e>//connection timeout in seconds</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Retries</span> = <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>StuffClientOptions</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>Timeout</span> = <span style=color:#a6e22e>t</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Connection</span> <span style=color:#66d9ef>struct</span> {}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>options</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClientOptions</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>options</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>conn</span>:    <span style=color:#a6e22e>conn</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>timeout</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Timeout</span>,
</span></span><span style=display:flex><span>            <span style=color:#a6e22e>retries</span>: <span style=color:#a6e22e>options</span>.<span style=color:#a6e22e>Retries</span>,
</span></span><span style=display:flex><span>        }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>stuffClient</span>) <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果你想自己尝试一下, 去 <a href=https://play.golang.org/p/VcWqWcAEyz>Go Playground</a> 吧.</p><p>但是可以通过删除 StuffClientOptions 结构并直接将选项应用到我们的 StuffClient 来进一步简化.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>var</span> <span style=color:#a6e22e>defaultStuffClient</span> = <span style=color:#a6e22e>stuffClient</span>{
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retries</span>: <span style=color:#ae81ff>3</span>,
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span>: <span style=color:#ae81ff>2</span>,
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClientOption</span> <span style=color:#66d9ef>func</span>(<span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithRetries</span>(<span style=color:#a6e22e>r</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>retries</span> = <span style=color:#a6e22e>r</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>WithTimeout</span>(<span style=color:#a6e22e>t</span> <span style=color:#66d9ef>int</span>) <span style=color:#a6e22e>StuffClientOption</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>func</span>(<span style=color:#a6e22e>o</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>stuffClient</span>) {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>.<span style=color:#a6e22e>timeout</span> = <span style=color:#a6e22e>t</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>StuffClient</span> <span style=color:#66d9ef>interface</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>stuffClient</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>conn</span>    <span style=color:#a6e22e>Connection</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>timeout</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>retries</span> <span style=color:#66d9ef>int</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>Connection</span> <span style=color:#66d9ef>struct</span>{}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewStuffClient</span>(<span style=color:#a6e22e>conn</span> <span style=color:#a6e22e>Connection</span>, <span style=color:#a6e22e>opts</span> <span style=color:#f92672>...</span><span style=color:#a6e22e>StuffClientOption</span>) <span style=color:#a6e22e>StuffClient</span> {
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>defaultStuffClient</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>o</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>opts</span> {
</span></span><span style=display:flex><span>        <span style=color:#a6e22e>o</span>(<span style=color:#f92672>&amp;</span><span style=color:#a6e22e>client</span>)
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#a6e22e>client</span>.<span style=color:#a6e22e>conn</span> = <span style=color:#a6e22e>conn</span>
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>client</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>c</span> <span style=color:#a6e22e>stuffClient</span>) <span style=color:#a6e22e>DoStuff</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>    <span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>可以在<a href=https://play.golang.org/p/Z5P5Om4KDL>这里</a>尝试一下. 在我们的示例中, 我们只是直接将配置应用到我们的结构中, 在中间有一个额外的配置结构是没有意义的. 但是请注意, 在许多情况下, 您可能仍然想使用前面示例中的 config 结构体; 例如, 如果你的构造器使用配置选项来执行一些操作, 但不把它们存储到结构中, 或者传递到其他地方. 配置结构变体是更通用的实现.</p><p>感谢 Rob Pike 和 Dave Cheney 推广这种设计模式.</p></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//douglarek.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=content__footer></footer></section><section class=page__aside><div class=aside__content><p>2018-02-01</p><hr>On this page:<nav id=TableOfContents></nav></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Copyright © 2025 Leo Douglas</p></footer></div></body></html>