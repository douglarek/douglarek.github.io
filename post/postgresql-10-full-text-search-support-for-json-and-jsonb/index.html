<!doctype html><html lang=zh><head><title>PostgreSQL 10 Full Text Search Support for JSON and JSONB &ndash; Code talks</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/palettes/base16-dark.css><link rel=stylesheet href=/css/risotto.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/favicon.ico><meta property="og:title" content="PostgreSQL 10 Full Text Search Support for JSON and JSONB &ndash; Code talks"><meta property="og:url" content="/post/postgresql-10-full-text-search-support-for-json-and-jsonb/"><meta property="og:locale" content="zh-CN"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4TVXFV2XZM%20"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4TVXFV2XZM ")}</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><li class=nomarker><h1 class=page__logo><a href=/ class=page__logo-inner>Code talks</a></h1></li><li class=main-nav__item><a class=nav-main-item href=/post title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class=nav-main-item href=https://github.com/douglarek title>GitHub</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>PostgreSQL 10 Full Text Search Support for JSON and JSONB</h1><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6649330439620894" crossorigin=anonymous></script></header><div class=content__body><p>这是对 JSON 数据的又一个很酷的补充. 现在我们可以轻松地添加 json 值的全文搜索.</p><p>一个它如何运作的快速例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>select</span> id, jsonb_pretty(payload) <span style=color:#66d9ef>from</span> test;
</span></span><span style=display:flex><span>id <span style=color:#f92672>|</span>                                                jsonb_pretty
</span></span><span style=display:flex><span><span style=color:#75715e>----+-------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>  <span style=color:#ae81ff>1</span> <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>{</span>                                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>     <span style=color:#e6db74>&#34;glossary&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>         <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;example glossary&#34;</span>,                                                                       <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>         <span style=color:#e6db74>&#34;GlossDiv&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                      <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>             <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;S&#34;</span>,                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>             <span style=color:#e6db74>&#34;GlossList&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                 <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                 <span style=color:#e6db74>&#34;GlossEntry&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                            <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;SGML&#34;</span>,                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;Abbrev&#34;</span>: <span style=color:#e6db74>&#34;ISO 8879:1986&#34;</span>,                                                             <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;SortAs&#34;</span>: <span style=color:#e6db74>&#34;SGML&#34;</span>,                                                                      <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;Acronym&#34;</span>: <span style=color:#e6db74>&#34;SGML&#34;</span>,                                                                     <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;GlossDef&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                         <span style=color:#e6db74>&#34;para&#34;</span>: <span style=color:#e6db74>&#34;A meta-markup language, used to create markup languages such as DocBook.&#34;</span>,<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                         <span style=color:#e6db74>&#34;GlossSeeAlso&#34;</span>: [                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                             <span style=color:#e6db74>&#34;GML&#34;</span>,                                                                         <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                             <span style=color:#e6db74>&#34;XML&#34;</span>                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                         ]                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#960050;background-color:#1e0010>}</span>,                                                                                     <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;GlossSee&#34;</span>: <span style=color:#e6db74>&#34;markup&#34;</span>,                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                     <span style=color:#e6db74>&#34;GlossTerm&#34;</span>: <span style=color:#e6db74>&#34;Standard Generalized Markup Language&#34;</span>                                    <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>                 <span style=color:#960050;background-color:#1e0010>}</span>                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>             <span style=color:#960050;background-color:#1e0010>}</span>                                                                                              <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>         <span style=color:#960050;background-color:#1e0010>}</span>                                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span>     <span style=color:#960050;background-color:#1e0010>}</span>                                                                                                      <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>|</span> <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span>)
</span></span></code></pre></div><p>正如你所看到的, 我有一个相当嵌套的 json 结构. 现在我们需要 tsvector 数据来构建一个索引. 我们可以这样:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>select</span> to_tsvector(<span style=color:#e6db74>&#39;english&#39;</span>, payload) <span style=color:#66d9ef>from</span> test;
</span></span><span style=display:flex><span>                                  to_tsvector
</span></span><span style=display:flex><span><span style=color:#75715e>--------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#e6db74>&#39;1986&#39;</span>:<span style=color:#ae81ff>8</span> <span style=color:#e6db74>&#39;8879&#39;</span>:<span style=color:#ae81ff>7</span> <span style=color:#e6db74>&#39;creat&#39;</span>:<span style=color:#ae81ff>21</span> <span style=color:#e6db74>&#39;docbook&#39;</span>:<span style=color:#ae81ff>26</span> <span style=color:#e6db74>&#39;exampl&#39;</span>:<span style=color:#ae81ff>1</span> <span style=color:#e6db74>&#39;general&#39;</span>:<span style=color:#ae81ff>35</span> <span style=color:#e6db74>&#39;glossari&#39;</span>:<span style=color:#ae81ff>2</span>.
</span></span><span style=display:flex><span>. <span style=color:#e6db74>&#39;gml&#39;</span>:<span style=color:#ae81ff>28</span> <span style=color:#e6db74>&#39;iso&#39;</span>:<span style=color:#ae81ff>6</span> <span style=color:#e6db74>&#39;languag&#39;</span>:<span style=color:#ae81ff>18</span>,<span style=color:#ae81ff>23</span>,<span style=color:#ae81ff>37</span> <span style=color:#e6db74>&#39;markup&#39;</span>:<span style=color:#ae81ff>17</span>,<span style=color:#ae81ff>22</span>,<span style=color:#ae81ff>32</span>,<span style=color:#ae81ff>36</span> <span style=color:#e6db74>&#39;meta&#39;</span>:<span style=color:#ae81ff>16</span> <span style=color:#e6db74>&#39;meta-mark.
</span></span></span><span style=display:flex><span><span style=color:#e6db74>.up&#39;</span>:<span style=color:#ae81ff>15</span> <span style=color:#e6db74>&#39;sgml&#39;</span>:<span style=color:#ae81ff>4</span>,<span style=color:#ae81ff>10</span>,<span style=color:#ae81ff>12</span> <span style=color:#e6db74>&#39;standard&#39;</span>:<span style=color:#ae81ff>34</span> <span style=color:#e6db74>&#39;use&#39;</span>:<span style=color:#ae81ff>19</span> <span style=color:#e6db74>&#39;xml&#39;</span>:<span style=color:#ae81ff>30</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span>)
</span></span></code></pre></div><p>很好. 它找到了 json 数据值中的所有单词(它没有索引对象的键).</p><p>还有与之匹配的 ts_headline 函数.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sql data-lang=sql><span style=display:flex><span><span style=color:#960050;background-color:#1e0010>$</span> <span style=color:#66d9ef>select</span> jsonb_pretty(ts_headline(payload, <span style=color:#e6db74>&#39;sgml&#39;</span>::tsquery)) <span style=color:#66d9ef>from</span> test;
</span></span><span style=display:flex><span>                                                jsonb_pretty
</span></span><span style=display:flex><span><span style=color:#75715e>-------------------------------------------------------------------------------------------------------------
</span></span></span><span style=display:flex><span><span style=color:#75715e></span> <span style=color:#960050;background-color:#1e0010>{</span>                                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>     <span style=color:#e6db74>&#34;glossary&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;example glossary&#34;</span>,                                                                       <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>         <span style=color:#e6db74>&#34;GlossDiv&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                      <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>             <span style=color:#e6db74>&#34;title&#34;</span>: <span style=color:#e6db74>&#34;S&#34;</span>,                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>             <span style=color:#e6db74>&#34;GlossList&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                                 <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                 <span style=color:#e6db74>&#34;GlossEntry&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                            <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;ID&#34;</span>: <span style=color:#e6db74>&#34;&lt;b&gt;SGML&lt;/b&gt;&#34;</span>,                                                                   <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;Abbrev&#34;</span>: <span style=color:#e6db74>&#34;ISO 8879:1986&#34;</span>,                                                             <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;SortAs&#34;</span>: <span style=color:#e6db74>&#34;&lt;b&gt;SGML&lt;/b&gt;&#34;</span>,                                                               <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;Acronym&#34;</span>: <span style=color:#e6db74>&#34;&lt;b&gt;SGML&lt;/b&gt;&#34;</span>,                                                              <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;GlossDef&#34;</span>: <span style=color:#960050;background-color:#1e0010>{</span>                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                         <span style=color:#e6db74>&#34;para&#34;</span>: <span style=color:#e6db74>&#34;A meta-markup language, used to create markup languages such as DocBook.&#34;</span>,<span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                         <span style=color:#e6db74>&#34;GlossSeeAlso&#34;</span>: [                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                             <span style=color:#e6db74>&#34;GML&#34;</span>,                                                                         <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                             <span style=color:#e6db74>&#34;XML&#34;</span>                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                         ]                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#960050;background-color:#1e0010>}</span>,                                                                                     <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;GlossSee&#34;</span>: <span style=color:#e6db74>&#34;markup&#34;</span>,                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                     <span style=color:#e6db74>&#34;GlossTerm&#34;</span>: <span style=color:#e6db74>&#34;Standard Generalized Markup Language&#34;</span>                                    <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>                 <span style=color:#960050;background-color:#1e0010>}</span>                                                                                          <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>             <span style=color:#960050;background-color:#1e0010>}</span>                                                                                              <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>         <span style=color:#960050;background-color:#1e0010>}</span>                                                                                                  <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span>     <span style=color:#960050;background-color:#1e0010>}</span>                                                                                                      <span style=color:#f92672>+</span>
</span></span><span style=display:flex><span> <span style=color:#960050;background-color:#1e0010>}</span>
</span></span><span style=display:flex><span>(<span style=color:#ae81ff>1</span> <span style=color:#66d9ef>row</span>)
</span></span></code></pre></div><p>请注意上面 SGML 字符串两边的 <b>.</p><p>讲真 - 我认为 JSON 被应用程序开发者滥用了很多, 但是这绝对是一个很好的补充, 非常感谢 Dmitry 和 Andrew.</p></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//douglarek.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=content__footer></footer></section><section class=page__aside><div class=aside__content><p>2017-10-10</p><hr>On this page:<nav id=TableOfContents></nav></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Copyright © 2025 Leo Douglas</p></footer></div></body></html>