<!doctype html><html lang=zh><head><title>Go errors 堆栈 &ndash; Code talks</title><meta name=viewport content="width=device-width,initial-scale=1"><meta charset=UTF-8><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css integrity="sha512-Kc323vGBEqzTmouAECnVceyQqyqdsSiqLQISBL29aUW4U/M7pSPA/gEUZQqv1cwx4OnYxTxve5UMg5GT6L4JJg==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=https://cdnjs.cloudflare.com/ajax/libs/academicons/1.9.4/css/academicons.min.css integrity="sha512-IW0nhlW5MgNydsXJO40En2EoCkTTjZhI3yuODrZIc8cQ4h1XcF53PsqDHa09NqnkXuIe0Oiyyj171BqZFwISBw==" crossorigin=anonymous referrerpolicy=no-referrer><link rel=stylesheet href=/css/palettes/base16-dark.css><link rel=stylesheet href=/css/risotto.css><link rel=stylesheet href=/css/custom.css><link rel=icon href=/favicon.ico><meta property="og:title" content="Go errors 堆栈 &ndash; Code talks"><meta property="og:url" content="/post/go-errors-stack-traces/"><meta property="og:locale" content="zh-CN"><script async src="https://www.googletagmanager.com/gtag/js?id=G-4TVXFV2XZM%20"></script><script>var dnt,doNotTrack=!1;if(!1&&(dnt=navigator.doNotTrack||window.doNotTrack||navigator.msDoNotTrack,doNotTrack=dnt=="1"||dnt=="yes"),!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-4TVXFV2XZM ")}</script></head><body><div class=page><header class=page__header><nav class="page__nav main-nav"><ul><li class=nomarker><h1 class=page__logo><a href=/ class=page__logo-inner>Code talks</a></h1></li><li class=main-nav__item><a class=nav-main-item href=/post title>Posts</a></li><li class=main-nav__item><a class=nav-main-item href=/tags title>Tags</a></li><li class=main-nav__item><a class=nav-main-item href=https://github.com/douglarek title>GitHub</a></li></ul></nav></header><section class=page__body><header class=content__header><h1>Go errors 堆栈</h1><script async src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-6649330439620894" crossorigin=anonymous></script></header><div class=content__body><p>相对于 C 语言来说, Go 在处理传统的逻辑错误上确实略高一筹. 至少一个 func 返回 error, 我们知道需要处理并且偶尔会进行传递, 而不是干巴巴等着运行时崩溃.</p><h2 id=errors-也是值>Errors 也是值</h2><p>我们每个人在学习 Go 的时候都被这样说服: <a href=https://blog.golang.org/errors-are-values>Errors are values</a>, 错误也是一种值, 就像其他任何类型的值一样.</p><p>我们先看一个简单的例子:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// https://play.golang.org/p/VFVX0fRKBnS</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strconv&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>strconv</span>.<span style=color:#a6e22e>ParseInt</span>(<span style=color:#e6db74>&#34;abcd&#34;</span>, <span style=color:#ae81ff>10</span>, <span style=color:#ae81ff>64</span>); <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span><span style=color:#75715e>// 输出</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// strconv.ParseInt: parsing &#34;abcd&#34;: invalid syntax</span>
</span></span></code></pre></div><p>看起来好像还不错, 起码我们知道 3 个内容:</p><ul><li>错误发生的 func: strconv.ParseInt</li><li>发生错误 func 的参数: abcd</li><li>错误的原因: invalid syntax</li></ul><p>如果查看 <a href="https://golang.org/src/strconv/atoi.go?s=4086:4153#L146">strconv.ParseInt</a> 的源码你会发现, 代码如标准库者依然没有使用最原始的 error 返回. 它之所以打印出上面的 3 个内容, 是因为使用了自定义的 NumError :</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// A NumError records a failed conversion.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>NumError</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Func</span> <span style=color:#66d9ef>string</span> <span style=color:#75715e>// the failing function (ParseBool, ParseInt, ParseUint, ParseFloat)</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Num</span>  <span style=color:#66d9ef>string</span> <span style=color:#75715e>// the input</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>Err</span>  <span style=color:#66d9ef>error</span>  <span style=color:#75715e>// the reason the conversion failed (e.g. ErrRange, ErrSyntax, etc.)</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>NumError</span>) <span style=color:#a6e22e>Error</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#e6db74>&#34;strconv.&#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Func</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;parsing &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>Quote</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Num</span>) <span style=color:#f92672>+</span> <span style=color:#e6db74>&#34;: &#34;</span> <span style=color:#f92672>+</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>Err</span>.<span style=color:#a6e22e>Error</span>()
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>如果我们领会了 Errors are values 的精神, 基本上能写出这样的错误处理已经很符合 <a href=https://dave.cheney.net/2016/04/27/dont-just-check-errors-handle-them-gracefully>不要仅仅检查 errors, 优雅的处理它们</a> 的宗旨了. 本文在这里也可能就结束了, 然后将标题改为: Go errors 指南 \ (•◡•) /.</p><h2 id=errors-堆栈跟踪>Errors 堆栈跟踪</h2><p>不, 这不够啊, 对于标准库可能每个错误都像那样模版式搞个花式自定义 error . 如果我们用过 Python 或者 Java 的 try, 不会不知道异常(可能有人在这里跟我掰 Go 里面 errors 不是异常)发生的时候, 打印行号等关键信息有多重要吧.</p><p>上面的 ParseInt 例子只是个简单的不能再简单的例子, 如果我们的工程和代码复杂度都上一个层次, 一个 func 里面可能需要处理多个第三方 func 返回的 errors. 一个简单的 errors 信息对于程序的调试并不友好. 当然你如果确保了像标准库那样给出了那样翔实的 errors 内容, 倒也不错. 即便是这样, 我觉得依然没有发生 errors 时给出文件和行号来得实用一些.</p><p>实现这个功能需要用到 Go 强大的 runtime 包, 我们尝试自己实现一个简单的自定义 errors 堆栈跟踪:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// https://play.golang.org/p/-tesfXuy9fc</span>
</span></span><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;runtime&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;strings&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>callers</span>() []<span style=color:#66d9ef>uintptr</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>pcs</span> [<span style=color:#ae81ff>32</span>]<span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>Callers</span>(<span style=color:#ae81ff>3</span>, <span style=color:#a6e22e>pcs</span>[:])
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>st</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>pcs</span>[<span style=color:#ae81ff>0</span>:<span style=color:#a6e22e>n</span>]
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>st</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>type</span> <span style=color:#a6e22e>trace</span> <span style=color:#66d9ef>struct</span> {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>m</span> <span style=color:#66d9ef>string</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>s</span> []<span style=color:#66d9ef>uintptr</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>e</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>trace</span>) <span style=color:#a6e22e>Error</span>() <span style=color:#66d9ef>string</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>b</span> <span style=color:#a6e22e>strings</span>.<span style=color:#a6e22e>Builder</span>
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>m</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;\n\n&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;Traceback:&#34;</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>for</span> <span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>pc</span> <span style=color:#f92672>:=</span> <span style=color:#66d9ef>range</span> <span style=color:#a6e22e>e</span>.<span style=color:#a6e22e>s</span> {
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fn</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>runtime</span>.<span style=color:#a6e22e>FuncForPC</span>(<span style=color:#a6e22e>pc</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#e6db74>&#34;\n&#34;</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>n</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>fn</span>.<span style=color:#a6e22e>FileLine</span>(<span style=color:#a6e22e>pc</span>)
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Sprintf</span>(<span style=color:#e6db74>&#34;%s:%d&#34;</span>, <span style=color:#a6e22e>f</span>, <span style=color:#a6e22e>n</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>b</span>.<span style=color:#a6e22e>String</span>()
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// NewTrace creates a simple traceable error.</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>NewTrace</span>(<span style=color:#a6e22e>message</span> <span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#f92672>&amp;</span><span style=color:#a6e22e>trace</span>{<span style=color:#a6e22e>m</span>: <span style=color:#a6e22e>message</span>, <span style=color:#a6e22e>s</span>: <span style=color:#a6e22e>callers</span>()}
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>f</span>() <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>NewTrace</span>(<span style=color:#e6db74>&#34;ooops&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Println</span>(<span style=color:#a6e22e>f</span>())
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// goplay 输出</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// ooops</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// Traceback:</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /tmp/sandbox315155193/main.go:41</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /tmp/sandbox315155193/main.go:45</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /usr/local/go/src/runtime/proc.go:207</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// /usr/local/go/src/runtime/asm_amd64p32.s:968</span>
</span></span></code></pre></div><p>虽然简单粗糙了一些, 但确实实现了我们要的简单 errors 堆栈跟踪.</p><h2 id=社区实现pkgerrors>社区实现(pkg/errors)</h2><p>我们当然不打算在平常的代码中使用这样一个简单的实现, 我们这里介绍一下社区已经存在的 <a href=https://github.com/pkg/errors>pkg/errors</a> 库.</p><p>对于标准库或者第三方库的 errors 返回我们需要一个简单的 wrap, 以便在同样使用 pkg/errors 的地方可以获取一致的 errors 体验:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#a6e22e>_</span>, <span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>ioutil</span>.<span style=color:#a6e22e>ReadAll</span>(<span style=color:#a6e22e>r</span>)
</span></span><span style=display:flex><span><span style=color:#66d9ef>if</span> <span style=color:#a6e22e>err</span> <span style=color:#f92672>!=</span> <span style=color:#66d9ef>nil</span> {
</span></span><span style=display:flex><span>        <span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Wrap</span>(<span style=color:#a6e22e>err</span>, <span style=color:#e6db74>&#34;read failed&#34;</span>)
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>我们看看怎样使用 pkg/errors 得到的 errors:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#f92672>package</span> <span style=color:#a6e22e>main</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>import</span> (
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;fmt&#34;</span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;os&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>	<span style=color:#e6db74>&#34;github.com/pkg/errors&#34;</span>
</span></span><span style=display:flex><span>)
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>parseArgs</span>(<span style=color:#a6e22e>args</span> []<span style=color:#66d9ef>string</span>) <span style=color:#66d9ef>error</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>if</span> len(<span style=color:#a6e22e>args</span>) &lt; <span style=color:#ae81ff>3</span> {
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>return</span> <span style=color:#a6e22e>errors</span>.<span style=color:#a6e22e>Errorf</span>(<span style=color:#e6db74>&#34;not enough arguments, expected at least 3, got %d&#34;</span>, len(<span style=color:#a6e22e>args</span>))
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>return</span> <span style=color:#66d9ef>nil</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseArgs</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%v\n&#34;</span>, <span style=color:#a6e22e>err</span>)
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 输出</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// not enough arguments, expected at least 3, got 0</span>
</span></span></code></pre></div><p>什么 ? 没有堆栈信息打印 ? pkg/errors 默认的 flag 是不打印堆栈信息的(虽然一直包含). 我们施展一下 Go Formatter 的魔法:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#75715e>// ...</span>
</span></span><span style=display:flex><span><span style=color:#66d9ef>func</span> <span style=color:#a6e22e>main</span>() {
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>err</span> <span style=color:#f92672>:=</span> <span style=color:#a6e22e>parseArgs</span>(<span style=color:#a6e22e>os</span>.<span style=color:#a6e22e>Args</span>[<span style=color:#ae81ff>1</span>:])
</span></span><span style=display:flex><span>	<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Printf</span>(<span style=color:#e6db74>&#34;%+v\n&#34;</span>, <span style=color:#a6e22e>err</span>) <span style=color:#75715e>// 没错, 加个 `+` flag</span>
</span></span><span style=display:flex><span>}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 输出</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// not enough arguments, expected at least 3, got 0</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// main.parseArgs</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	/Users/xxx/.go/src/github.com/gorocks/snippets/go/cmd/gosnippets/main.go:12</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// main.main</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	/Users/xxx/.go/src/github.com/gorocks/snippets/go/cmd/gosnippets/main.go:18</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// runtime.main</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	/usr/local/Cellar/go/1.10.1/libexec/src/runtime/proc.go:198</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// runtime.goexit</span>
</span></span><span style=display:flex><span><span style=color:#75715e>// 	/usr/local/Cellar/go/1.10.1/libexec/src/runtime/asm_amd64.s:2361</span>
</span></span></code></pre></div><p>之所以会有这个效果是因为 pkg/errors 实现了 <a href=https://golang.org/pkg/fmt/#Formatter>Formatter</a> 接口:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-go data-lang=go><span style=display:flex><span><span style=color:#66d9ef>func</span> (<span style=color:#a6e22e>f</span> <span style=color:#f92672>*</span><span style=color:#a6e22e>fundamental</span>) <span style=color:#a6e22e>Format</span>(<span style=color:#a6e22e>s</span> <span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>State</span>, <span style=color:#a6e22e>verb</span> <span style=color:#66d9ef>rune</span>) {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>switch</span> <span style=color:#a6e22e>verb</span> {
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;v&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>if</span> <span style=color:#a6e22e>s</span>.<span style=color:#a6e22e>Flag</span>(<span style=color:#e6db74>&#39;+&#39;</span>) {
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>			<span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>stack</span>.<span style=color:#a6e22e>Format</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>verb</span>)
</span></span><span style=display:flex><span>			<span style=color:#66d9ef>return</span>
</span></span><span style=display:flex><span>		}
</span></span><span style=display:flex><span>		<span style=color:#66d9ef>fallthrough</span>
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;s&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>io</span>.<span style=color:#a6e22e>WriteString</span>(<span style=color:#a6e22e>s</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>	<span style=color:#66d9ef>case</span> <span style=color:#e6db74>&#39;q&#39;</span>:
</span></span><span style=display:flex><span>		<span style=color:#a6e22e>fmt</span>.<span style=color:#a6e22e>Fprintf</span>(<span style=color:#a6e22e>s</span>, <span style=color:#e6db74>&#34;%q&#34;</span>, <span style=color:#a6e22e>f</span>.<span style=color:#a6e22e>msg</span>)
</span></span><span style=display:flex><span>	}
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>实现 Formatter 的一个好处是, 我们可以如使用标准库般始终如一, 没有多余的任何 func 调用.</p><h2 id=benchmark>Benchmark</h2><p>pkg/errors 堆栈跟踪不是没有运行时开销的, <a href=https://github.com/pkg/errors/issues/72>官方</a>给出的指标是每个操作大约 1000-3000 ns.</p><p>一般来说这不会构成性能忧虑. 如果超过了你的性能预期, 可以定制成调试模式启用.</p><h2 id=参考资料>参考资料</h2><ul><li><a href=https://blog.golang.org/errors-are-values>Errors are values</a></li><li><a href=https://dave.cheney.net/2016/06/12/stack-traces-and-the-errors-package>Stack traces and the errors package</a></li><li><a href=https://github.com/pkg/errors>pkg/errors</a></li></ul></div><div id=disqus_thread></div><script>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//douglarek.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a><footer class=content__footer></footer></section><section class=page__aside><div class=aside__content><p>2018-04-12</p><hr>On this page:<nav id=TableOfContents><ul><li><a href=#errors-也是值>Errors 也是值</a></li><li><a href=#errors-堆栈跟踪>Errors 堆栈跟踪</a></li><li><a href=#社区实现pkgerrors>社区实现(pkg/errors)</a></li><li><a href=#benchmark>Benchmark</a></li><li><a href=#参考资料>参考资料</a></li></ul></nav></div></section><footer class=page__footer><p></p><br><br><p class=copyright>Copyright © 2025 Leo Douglas</p></footer></div></body></html>